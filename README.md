# 🏪 Team-FOG User Service

## 📋 개요

Team-FOG 프로젝트의 **User Service**는 사용자 인증, 회원가입, 마이페이지 기능을 담당하는 마이크로서비스입니다.

- **담당자**: User Service 담당자
- **포트**: 8082
- **기술 스택**: Spring Boot 3.4.0, Java 21, H2/Oracle DB (PDB + Standby), AWS Cognito
- **인증 방식**: AWS Cognito JWT 토큰 기반

## 🚀 빠른 시작

### 1. 개발 환경 설정

```bash
# 프로젝트 클론
git clone https://github.com/Jay-yoons/Team-FOG.git
cd Team-FOG

# 애플리케이션 실행
./gradlew bootRun
```

### 2. API 테스트

REST Client 확장프로그램을 사용하여 `api-tests-with-token.http` 파일로 API를 테스트할 수 있습니다.

```bash
# 더미 로그인으로 토큰 받기
curl -X GET "http://localhost:8082/api/users/login/dummy?state=test-state"

# 토큰으로 API 호출
curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost:8082/api/users/me
```

## 🔐 인증 시스템

### AWS Cognito 설정

현재 **더미 모드**로 설정되어 있어 실제 AWS Cognito 없이도 개발 및 테스트가 가능합니다.

```yaml
# application.yml
aws:
  cognito:
    dummy-mode: true  # 개발용 더미 모드
```

### 실제 서비스 전환 시

```yaml
aws:
  cognito:
    dummy-mode: false  # 실제 Cognito 사용
    user-pool-id: ${COGNITO_USER_POOL_ID}
    client-id: ${COGNITO_CLIENT_ID}
    client-secret: ${COGNITO_CLIENT_SECRET}
```

## 📊 데이터베이스 스키마

### Users 테이블 (Oracle PDB)
```sql
-- PDB: TEAMFOG
CREATE TABLE users (
    user_id VARCHAR2(15) PRIMARY KEY,
    user_name VARCHAR2(20) NOT NULL,
    phone_number VARCHAR2(20) UNIQUE NOT NULL,
    user_location VARCHAR2(50),
    password VARCHAR2(255) NOT NULL,
    is_active NUMBER(1) DEFAULT 1 NOT NULL,
    created_at TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    updated_at TIMESTAMP
);
```

### Favorite Stores 테이블 (Oracle PDB)
```sql
-- PDB: TEAMFOG
CREATE TABLE mv_fav_store (
    fav_store_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id VARCHAR2(15) NOT NULL,
    store_id VARCHAR2(20) NOT NULL,
    created_at TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CONSTRAINT fav_store_un UNIQUE (user_id, store_id)
);
```

### 개발 환경 (H2 Database)
개발 환경에서는 H2 인메모리 데이터베이스를 사용합니다.

### 운영 환경 (Oracle PDB + Standby)
- **PrimaryDB**: 쓰기 작업 및 읽기 작업
- **StandbyDB**: 읽기 전용 작업 (리포지션)

## 🔌 API 엔드포인트

### 인증 관련 API

| 메서드 | 엔드포인트 | 설명 | 인증 필요 |
|--------|------------|------|-----------|
| GET | `/api/users/login/url` | Cognito 로그인 URL 생성 | ❌ |
| GET | `/api/users/login/dummy` | 더미 로그인 (개발용) | ❌ |
| POST | `/api/users/login/callback` | Cognito 콜백 처리 | ❌ |
| POST | `/api/users/logout` | 로그아웃 | ✅ |

### 사용자 관리 API

| 메서드 | 엔드포인트 | 설명 | 인증 필요 |
|--------|------------|------|-----------|
| POST | `/api/users` | 회원가입 | ❌ |
| GET | `/api/users/me` | 내 정보 조회 | ✅ |
| PUT | `/api/users/me` | 사용자 정보 수정 | ✅ |
| GET | `/api/users/count` | 전체 사용자 수 조회 | ❌ |

### 마이페이지 API

| 메서드 | 엔드포인트 | 설명 | 인증 필요 |
|--------|------------|------|-----------|
| GET | `/api/users/me/reviews` | 내가 작성한 리뷰 목록 | ✅ |
| GET | `/api/users/me/reviews/{reviewId}/store-info` | 리뷰 관련 가게 정보 | ✅ |
| GET | `/api/users/me/favorites` | 내 즐겨찾기 가게 목록 | ✅ |
| POST | `/api/users/me/favorites` | 즐겨찾기 가게 추가 | ✅ |
| DELETE | `/api/users/me/favorites/{storeId}` | 즐겨찾기 가게 삭제 | ✅ |
| GET | `/api/users/me/favorites/{storeId}/check` | 즐겨찾기 상태 확인 | ✅ |
| GET | `/api/users/me/favorites/count` | 즐겨찾기 가게 개수 | ✅ |

### 개발용 API

| 메서드 | 엔드포인트 | 설명 | 인증 필요 |
|--------|------------|------|-----------|
| POST | `/api/users/dummy/data` | 더미 데이터 생성 | ❌ |
| GET | `/api/users/health` | 서비스 헬스체크 | ❌ |

## 🔄 MSA 연동

### Store Service 연동

User Service는 Store Service와 연동하여 리뷰 데이터를 가져옵니다.

```java
// Store Service에서 리뷰 데이터 가져오기
List<ReviewDto> reviews = storeServiceIntegration.getUserReviews(userId);

// Store Service에서 가게 정보 가져오기
Map<String, Object> storeInfo = storeServiceIntegration.getStoreInfoForReview(reviewId);
```

### 서비스 URL 설정

```yaml
# application.yml
msa:
  service-urls:
    store-service: http://localhost:8081  # Store Service URL
    reservation-service: http://localhost:8080  # Reservation Service URL
```

## 🧪 테스트

### 1. 더미 로그인 테스트

```bash
# 더미 로그인
curl -X GET "http://localhost:8082/api/users/login/dummy?state=test-state"
```

응답 예시:
```json
{
  "success": true,
  "accessToken": "dummy-access-token-1234567890",
  "idToken": "dummy-id-token-1234567890",
  "refreshToken": "dummy-refresh-token-1234567890",
  "tokenType": "Bearer",
  "expiresIn": 3600,
  "userInfo": {
    "sub": "dummy4879",
    "name": "더미 사용자",
    "email": "dummy@example.com"
  },
  "message": "더미 로그인 성공"
}
```

### 2. 인증된 API 테스트

```bash
# 내 정보 조회
curl -H "Authorization: Bearer dummy-access-token-1234567890" \
  http://localhost:8082/api/users/me
```

응답 예시:
```json
{
  "userId": "dummy4879",
  "userName": "더미 사용자",
  "phoneNumber": "010-1234-5678",
  "userLocation": "서울시 강남구",
  "createdAt": "2025-08-12T10:14:10.085936",
  "updatedAt": "2025-08-12T10:14:10.085936",
  "active": true
}
```

### 3. 더미 데이터 생성

```bash
# 더미 사용자 및 즐겨찾기 데이터 생성
curl -X POST http://localhost:8082/api/users/dummy/data
```

## 🔧 개발 환경

### 필수 요구사항

- Java 21
- Gradle 8.x
- H2 Database (개발용)
- Oracle Database (프로덕션용)

### 주요 의존성

```gradle
dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'com.auth0:java-jwt:4.4.0'
    implementation 'software.amazon.awssdk:cognitoidentityprovider:2.21.0'
    implementation 'com.h2database:h2'  // 개발용
    implementation 'com.oracle.database.jdbc:ojdbc11:23.3.0.23.09'  // Oracle DB (프로덕션용)
}
```

### 환경변수

```bash
# 개발 환경
SPRING_PROFILES_ACTIVE=dev

# 프로덕션 환경
SPRING_PROFILES_ACTIVE=prod
COGNITO_USER_POOL_ID=ap-northeast-2_xxxxxxxxx
COGNITO_CLIENT_ID=xxxxxxxxxxxxxxxxxxxxxxxxxxx
COGNITO_CLIENT_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxx

# Oracle Database 설정 (PDB + Standby)
# PrimaryDB
ORACLE_HOST=primarydb.internal
ORACLE_PORT=1521
ORACLE_SERVICE_NAME=TEAMFOG
ORACLE_USERNAME=user_service
ORACLE_PASSWORD=xxxxxxxxxxxx

# StandbyDB (Read-Only)
ORACLE_STANDBY_HOST=standbydb.internal
ORACLE_STANDBY_PORT=1521
ORACLE_STANDBY_SERVICE_NAME=TEAMFOG
ORACLE_STANDBY_USERNAME=user_service_readonly
ORACLE_STANDBY_PASSWORD=xxxxxxxxxxxx
```

## 📁 프로젝트 구조

```
src/main/java/com/restaurant/reservation/
├── UserServiceApplication.java          # 메인 애플리케이션
├── controller/
│   └── UserController.java              # API 컨트롤러
├── service/
│   ├── UserService.java                 # 사용자 비즈니스 로직
│   ├── AwsCognitoService.java           # Cognito 연동 서비스
│   └── StoreServiceIntegration.java     # Store Service 연동
├── config/
│   ├── SecurityConfig.java              # Spring Security 설정
│   ├── AwsCognitoConfig.java            # Cognito 설정
│   ├── CognitoAuthenticationFilter.java # JWT 인증 필터
│   └── MsaConfig.java                   # MSA 설정
├── entity/
│   ├── User.java                        # 사용자 엔티티
│   └── FavoriteStore.java               # 즐겨찾기 엔티티
├── repository/
│   ├── UserRepository.java              # 사용자 리포지토리
│   └── FavoriteStoreRepository.java     # 즐겨찾기 리포지토리
├── dto/
│   ├── UserInfoDto.java                 # 사용자 정보 DTO
│   ├── ReviewDto.java                   # 리뷰 DTO
│   └── FavoriteStoreDto.java            # 즐겨찾기 DTO
└── exception/
    ├── ServiceConnectionException.java   # 서비스 연결 예외
    └── ServiceHttpException.java         # HTTP 예외
```

## 🚨 문제 해결

### 1. 포트 충돌

```bash
# 8082 포트 사용 중인 프로세스 확인
netstat -ano | findstr :8082

# 프로세스 종료
taskkill /f /im java.exe
```

### 2. 데이터베이스 연결 실패

```bash
# H2 콘솔 접속 (개발용)
http://localhost:8082/h2-console
JDBC URL: jdbc:h2:mem:userdb
Username: sa
Password: (비어있음)
```

### 3. 인증 실패

- 토큰이 올바른지 확인
- 토큰 만료 시간 확인
- Authorization 헤더 형식 확인: `Bearer YOUR_TOKEN`

## 📞 연락처

- **담당자**: User Service 담당자
- **이메일**: user-service@team-fog.com
- **슬랙**: #user-service

## 📚 추가 문서

- [배포 가이드](docs/DEPLOYMENT_GUIDE.md) - AWS ECS 배포 방법
- [API 문서](docs/API_DOCUMENTATION.md) - 상세 API 명세
- [MSA 연동 가이드](docs/MSA_INTEGRATION.md) - 다른 서비스와의 연동 방법
