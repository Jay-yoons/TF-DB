# ğŸš€ JWT ê¸°ë°˜ MSA ì¸ì¦ ì‹œìŠ¤í…œ - ë¹ ë¥¸ ì‹œì‘ ê°€ì´ë“œ

## âš¡ 5ë¶„ ë§Œì— ì´í•´í•˜ê¸°

### ğŸ”„ ê¸°ì¡´ HttpSession â†’ JWT í† í° ì „í™˜

**ê¸°ì¡´ ë°©ì‹ (HttpSession):**
```java
// ë¡œê·¸ì¸ ì‹œ
session.setAttribute("userId", user.getUserId());
session.setAttribute("userName", user.getUserName());

// API í˜¸ì¶œ ì‹œ
String userId = (String) session.getAttribute("userId");
```

**ìƒˆë¡œìš´ ë°©ì‹ (JWT):**
```java
// ë¡œê·¸ì¸ ì‹œ
String token = jwtService.generateToken(userId, userName, serviceName);

// API í˜¸ì¶œ ì‹œ
String token = request.getHeader("Authorization").substring(7);
String userId = jwtService.getUserIdFromToken(token);
```

### ğŸ¯ í•µì‹¬ ì°¨ì´ì 

| êµ¬ë¶„ | HttpSession | JWT í† í° |
|------|-------------|----------|
| **ì„œë²„ ë©”ëª¨ë¦¬** | ì‚¬ìš©ìë§ˆë‹¤ ì„¸ì…˜ ì €ì¥ | ì‚¬ìš©í•˜ì§€ ì•ŠìŒ |
| **í™•ì¥ì„±** | ì„œë²„ ì—¬ëŸ¬ ëŒ€ ì‹œ ë³µì¡ | ì„œë²„ ê°„ ë…ë¦½ì  |
| **ëª¨ë°”ì¼** | ì–´ë ¤ì›€ | ì‰¬ì›€ |
| **MSA** | ë¶€ì í•© | ì í•© |

---

## ğŸ› ï¸ 3ë‹¨ê³„ë¡œ ì ìš©í•˜ê¸°

### 1ë‹¨ê³„: ì˜ì¡´ì„± ì¶”ê°€
```gradle
// build.gradleì— ì¶”ê°€
implementation 'io.jsonwebtoken:jjwt-api:0.12.3'
runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.12.3'
runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.12.3'
```

### 2ë‹¨ê³„: ì„¤ì • ì¶”ê°€
```yaml
# application.ymlì— ì¶”ê°€
jwt:
  secret: your-secret-key-here
  expiration: 86400000  # 24ì‹œê°„
  issuer: your-service-name
  allowed-services:
    - your-service-name
    - other-service-name
```

### 3ë‹¨ê³„: ì»¨íŠ¸ë¡¤ëŸ¬ ìˆ˜ì •
```java
// ê¸°ì¡´ HttpSession ë°©ì‹
@PostMapping("/login")
public ResponseEntity<?> login(@RequestBody LoginRequest request, HttpSession session) {
    // ë¡œê·¸ì¸ ì²˜ë¦¬
    session.setAttribute("userId", user.getUserId());
    return ResponseEntity.ok("ë¡œê·¸ì¸ ì„±ê³µ");
}

// ìƒˆë¡œìš´ JWT ë°©ì‹
@PostMapping("/login")
public ResponseEntity<?> login(@RequestBody LoginRequest request) {
    // ë¡œê·¸ì¸ ì²˜ë¦¬
    String token = jwtService.generateToken(user.getUserId(), user.getUserName(), "your-service");
    return ResponseEntity.ok(Map.of("token", token));
}
```

---

## ğŸ§ª ì¦‰ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°

### 1. í† í° ìƒì„± í…ŒìŠ¤íŠ¸
```bash
curl -X POST http://localhost:8080/api/msa-test/generate-token \
  -H "Content-Type: application/json" \
  -d '{"userId": "testuser", "userName": "í…ŒìŠ¤íŠ¸"}'
```

### 2. í† í° ê²€ì¦ í…ŒìŠ¤íŠ¸
```bash
# 1ë‹¨ê³„ì—ì„œ ë°›ì€ í† í°ìœ¼ë¡œ í…ŒìŠ¤íŠ¸
curl -X POST http://localhost:8080/api/msa-test/validate-token \
  -H "Content-Type: application/json" \
  -d '{"token": "ì—¬ê¸°ì—_í† í°_ì…ë ¥"}'
```

### 3. ë³´í˜¸ëœ API í…ŒìŠ¤íŠ¸
```bash
curl -X GET http://localhost:8080/api/protected-resource \
  -H "Authorization: Bearer ì—¬ê¸°ì—_í† í°_ì…ë ¥"
```

---

## ğŸ“š ì£¼ìš” í´ë˜ìŠ¤ ì‚¬ìš©ë²•

### JwtService ì‚¬ìš©ë²•
```java
@Autowired
private JwtService jwtService;

// í† í° ìƒì„±
String token = jwtService.generateToken("user123", "í™ê¸¸ë™", "my-service");

// í† í° ê²€ì¦
if (jwtService.validateToken(token)) {
    String userId = jwtService.getUserIdFromToken(token);
    // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
}

// í† í° ë§Œë£Œ í™•ì¸
if (jwtService.isTokenExpired(token)) {
    // í† í° ê°±ì‹  í•„ìš”
}
```

### MsaIntegrationService ì‚¬ìš©ë²•
```java
@Autowired
private MsaIntegrationService msaIntegrationService;

// ë‹¤ë¥¸ ì„œë¹„ìŠ¤ í˜¸ì¶œ
Map<String, Object> result = msaIntegrationService.callExternalService(
    "http://localhost:8081",  // ë‹¤ë¥¸ ì„œë¹„ìŠ¤ URL
    "/api/data",             // ì—”ë“œí¬ì¸íŠ¸
    "user123",               // ì‚¬ìš©ì ID
    "í™ê¸¸ë™"                  // ì‚¬ìš©ì ì´ë¦„
);
```

---

## ğŸ”’ ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

### âœ… í•„ìˆ˜ ë³´ì•ˆ ì„¤ì •
- [ ] ì‹œí¬ë¦¿ í‚¤ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬
- [ ] HTTPS ì‚¬ìš©
- [ ] í† í° ë§Œë£Œ ì‹œê°„ ì ì ˆíˆ ì„¤ì • (15ë¶„~24ì‹œê°„)
- [ ] í—ˆìš©ëœ ì„œë¹„ìŠ¤ ëª©ë¡ ê´€ë¦¬
- [ ] CORS ì„¤ì •

### âœ… ê¶Œì¥ ë³´ì•ˆ ì„¤ì •
- [ ] í† í° ë¸”ë™ë¦¬ìŠ¤íŠ¸ êµ¬í˜„
- [ ] ë¦¬í”„ë ˆì‹œ í† í° ì‚¬ìš©
- [ ] ì •ê¸°ì ì¸ ì‹œí¬ë¦¿ í‚¤ êµì²´
- [ ] ë¡œê·¸ì—ì„œ ë¯¼ê° ì •ë³´ ì œê±°

---

## ğŸš¨ ì£¼ì˜ì‚¬í•­

### âŒ í•˜ì§€ ë§ì•„ì•¼ í•  ê²ƒë“¤
```java
// âŒ ì‹œí¬ë¦¿ í‚¤ë¥¼ ì†ŒìŠ¤ì½”ë“œì— í•˜ë“œì½”ë”©
private String secret = "my-secret-key";

// âŒ í† í°ì— ë¯¼ê°í•œ ì •ë³´ í¬í•¨
claims.put("password", user.getPassword());

// âŒ í† í° ë§Œë£Œ ì‹œê°„ì„ ë„ˆë¬´ ê¸¸ê²Œ ì„¤ì •
expiration: 31536000000  // 1ë…„
```

### âœ… ì˜¬ë°”ë¥¸ ë°©ë²•
```java
// âœ… í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©
@Value("${JWT_SECRET}")
private String secret;

// âœ… í•„ìš”í•œ ì •ë³´ë§Œ í¬í•¨
claims.put("userId", user.getUserId());
claims.put("userName", user.getUserName());

// âœ… ì ì ˆí•œ ë§Œë£Œ ì‹œê°„ ì„¤ì •
expiration: 900000  // 15ë¶„
```

---

## ğŸ”§ ë¬¸ì œ í•´ê²°

### ìì£¼ ë°œìƒí•˜ëŠ” ë¬¸ì œë“¤

**1. í† í° ê²€ì¦ ì‹¤íŒ¨**
```java
// í•´ê²°: ì‹œí¬ë¦¿ í‚¤ í™•ì¸
@Value("${jwt.secret}")
private String secret;
```

**2. ì„œë¹„ìŠ¤ ê°„ í†µì‹  ì‹¤íŒ¨**
```java
// í•´ê²°: í—ˆìš©ëœ ì„œë¹„ìŠ¤ ëª©ë¡ í™•ì¸
if (!jwtConfig.isAllowedService(serviceName)) {
    throw new IllegalArgumentException("Service not allowed");
}
```

**3. í† í° ë§Œë£Œ**
```java
// í•´ê²°: ë¦¬í”„ë ˆì‹œ í† í° ì‚¬ìš©
if (jwtService.isTokenExpired(token)) {
    String newToken = jwtService.generateToken(userId, userName, serviceName);
}
```

---

## ğŸ“ ë„ì›€ë§

### ğŸ†˜ ë¬¸ì œê°€ ë°œìƒí•˜ë©´
1. **ë¡œê·¸ í™•ì¸**: `application.yml`ì—ì„œ ë¡œê·¸ ë ˆë²¨ì„ DEBUGë¡œ ì„¤ì •
2. **í† í° ê²€ì¦**: `/api/msa-test/validate-token` APIë¡œ í† í° ìƒíƒœ í™•ì¸
3. **ì„¤ì • í™•ì¸**: `jwt.secret`, `jwt.allowed-services` ì„¤ì • í™•ì¸
4. **ë¬¸ì„œ ì°¸ì¡°**: `JWT_MSA_ê°€ì´ë“œ.md` ìƒì„¸ ë¬¸ì„œ í™•ì¸

### ğŸ“š ì¶”ê°€ í•™ìŠµ ìë£Œ
- [JWT ê³µì‹ ì‚¬ì´íŠ¸](https://jwt.io/)
- [Spring Security JWT](https://spring.io/guides/tutorials/spring-security-and-angular-js/)
- [MSA íŒ¨í„´](https://microservices.io/)

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

1. **ê¸°ì¡´ HttpSession ì½”ë“œë¥¼ JWTë¡œ ì „í™˜**
2. **ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì™€ì˜ í†µì‹  í…ŒìŠ¤íŠ¸**
3. **ë³´ì•ˆ ì„¤ì • ê°•í™”**
4. **ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹… ì¶”ê°€**

---

**ğŸ’¡ ì´ ê°€ì´ë“œë¡œ JWT ì‹œìŠ¤í…œì„ ë¹ ë¥´ê²Œ ì ìš©í•˜ê³ , ìƒì„¸í•œ ë¬¸ì„œ(`JWT_MSA_ê°€ì´ë“œ.md`)ë¥¼ ì°¸ì¡°í•˜ì—¬ ì™„ì „íˆ ì´í•´í•˜ì„¸ìš”!**
