# 🚀 JWT 기반 MSA 인증 시스템 - 빠른 시작 가이드

## ⚡ 5분 만에 이해하기

### 🔄 기존 HttpSession → JWT 토큰 전환

**기존 방식 (HttpSession):**
```java
// 로그인 시
session.setAttribute("userId", user.getUserId());
session.setAttribute("userName", user.getUserName());

// API 호출 시
String userId = (String) session.getAttribute("userId");
```

**새로운 방식 (JWT):**
```java
// 로그인 시
String token = jwtService.generateToken(userId, userName, serviceName);

// API 호출 시
String token = request.getHeader("Authorization").substring(7);
String userId = jwtService.getUserIdFromToken(token);
```

### 🎯 핵심 차이점

| 구분 | HttpSession | JWT 토큰 |
|------|-------------|----------|
| **서버 메모리** | 사용자마다 세션 저장 | 사용하지 않음 |
| **확장성** | 서버 여러 대 시 복잡 | 서버 간 독립적 |
| **모바일** | 어려움 | 쉬움 |
| **MSA** | 부적합 | 적합 |

---

## 🛠️ 3단계로 적용하기

### 1단계: 의존성 추가
```gradle
// build.gradle에 추가
implementation 'io.jsonwebtoken:jjwt-api:0.12.3'
runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.12.3'
runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.12.3'
```

### 2단계: 설정 추가
```yaml
# application.yml에 추가
jwt:
  secret: your-secret-key-here
  expiration: 86400000  # 24시간
  issuer: your-service-name
  allowed-services:
    - your-service-name
    - other-service-name
```

### 3단계: 컨트롤러 수정
```java
// 기존 HttpSession 방식
@PostMapping("/login")
public ResponseEntity<?> login(@RequestBody LoginRequest request, HttpSession session) {
    // 로그인 처리
    session.setAttribute("userId", user.getUserId());
    return ResponseEntity.ok("로그인 성공");
}

// 새로운 JWT 방식
@PostMapping("/login")
public ResponseEntity<?> login(@RequestBody LoginRequest request) {
    // 로그인 처리
    String token = jwtService.generateToken(user.getUserId(), user.getUserName(), "your-service");
    return ResponseEntity.ok(Map.of("token", token));
}
```

---

## 🧪 즉시 테스트하기

### 1. 토큰 생성 테스트
```bash
curl -X POST http://localhost:8080/api/msa-test/generate-token \
  -H "Content-Type: application/json" \
  -d '{"userId": "testuser", "userName": "테스트"}'
```

### 2. 토큰 검증 테스트
```bash
# 1단계에서 받은 토큰으로 테스트
curl -X POST http://localhost:8080/api/msa-test/validate-token \
  -H "Content-Type: application/json" \
  -d '{"token": "여기에_토큰_입력"}'
```

### 3. 보호된 API 테스트
```bash
curl -X GET http://localhost:8080/api/protected-resource \
  -H "Authorization: Bearer 여기에_토큰_입력"
```

---

## 📚 주요 클래스 사용법

### JwtService 사용법
```java
@Autowired
private JwtService jwtService;

// 토큰 생성
String token = jwtService.generateToken("user123", "홍길동", "my-service");

// 토큰 검증
if (jwtService.validateToken(token)) {
    String userId = jwtService.getUserIdFromToken(token);
    // 비즈니스 로직
}

// 토큰 만료 확인
if (jwtService.isTokenExpired(token)) {
    // 토큰 갱신 필요
}
```

### MsaIntegrationService 사용법
```java
@Autowired
private MsaIntegrationService msaIntegrationService;

// 다른 서비스 호출
Map<String, Object> result = msaIntegrationService.callExternalService(
    "http://localhost:8081",  // 다른 서비스 URL
    "/api/data",             // 엔드포인트
    "user123",               // 사용자 ID
    "홍길동"                  // 사용자 이름
);
```

---

## 🔒 보안 체크리스트

### ✅ 필수 보안 설정
- [ ] 시크릿 키를 환경변수로 관리
- [ ] HTTPS 사용
- [ ] 토큰 만료 시간 적절히 설정 (15분~24시간)
- [ ] 허용된 서비스 목록 관리
- [ ] CORS 설정

### ✅ 권장 보안 설정
- [ ] 토큰 블랙리스트 구현
- [ ] 리프레시 토큰 사용
- [ ] 정기적인 시크릿 키 교체
- [ ] 로그에서 민감 정보 제거

---

## 🚨 주의사항

### ❌ 하지 말아야 할 것들
```java
// ❌ 시크릿 키를 소스코드에 하드코딩
private String secret = "my-secret-key";

// ❌ 토큰에 민감한 정보 포함
claims.put("password", user.getPassword());

// ❌ 토큰 만료 시간을 너무 길게 설정
expiration: 31536000000  // 1년
```

### ✅ 올바른 방법
```java
// ✅ 환경변수 사용
@Value("${JWT_SECRET}")
private String secret;

// ✅ 필요한 정보만 포함
claims.put("userId", user.getUserId());
claims.put("userName", user.getUserName());

// ✅ 적절한 만료 시간 설정
expiration: 900000  // 15분
```

---

## 🔧 문제 해결

### 자주 발생하는 문제들

**1. 토큰 검증 실패**
```java
// 해결: 시크릿 키 확인
@Value("${jwt.secret}")
private String secret;
```

**2. 서비스 간 통신 실패**
```java
// 해결: 허용된 서비스 목록 확인
if (!jwtConfig.isAllowedService(serviceName)) {
    throw new IllegalArgumentException("Service not allowed");
}
```

**3. 토큰 만료**
```java
// 해결: 리프레시 토큰 사용
if (jwtService.isTokenExpired(token)) {
    String newToken = jwtService.generateToken(userId, userName, serviceName);
}
```

---

## 📞 도움말

### 🆘 문제가 발생하면
1. **로그 확인**: `application.yml`에서 로그 레벨을 DEBUG로 설정
2. **토큰 검증**: `/api/msa-test/validate-token` API로 토큰 상태 확인
3. **설정 확인**: `jwt.secret`, `jwt.allowed-services` 설정 확인
4. **문서 참조**: `JWT_MSA_가이드.md` 상세 문서 확인

### 📚 추가 학습 자료
- [JWT 공식 사이트](https://jwt.io/)
- [Spring Security JWT](https://spring.io/guides/tutorials/spring-security-and-angular-js/)
- [MSA 패턴](https://microservices.io/)

---

## 🎯 다음 단계

1. **기존 HttpSession 코드를 JWT로 전환**
2. **다른 서비스와의 통신 테스트**
3. **보안 설정 강화**
4. **모니터링 및 로깅 추가**

---

**💡 이 가이드로 JWT 시스템을 빠르게 적용하고, 상세한 문서(`JWT_MSA_가이드.md`)를 참조하여 완전히 이해하세요!**
