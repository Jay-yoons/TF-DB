# ğŸš€ User Service ë°°í¬ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

ì´ ë¬¸ì„œëŠ” User Serviceë¥¼ AWS MSA í™˜ê²½ì—ì„œ ì‹¤ì œ ì„œë¹„ìŠ¤ë¡œ ë°°í¬í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

## ğŸ”§ ë”ë¯¸ ëª¨ë“œì—ì„œ ì‹¤ì œ ì„œë¹„ìŠ¤ë¡œ ì „í™˜

### 1. ì„¤ì • íŒŒì¼ ë³€ê²½

#### application.yml ìˆ˜ì •
```yaml
aws:
  cognito:
    dummy-mode: false  # ì‹¤ì œ Cognito ì‚¬ìš©
    user-pool-id: ${COGNITO_USER_POOL_ID}
    client-id: ${COGNITO_CLIENT_ID}
    client-secret: ${COGNITO_CLIENT_SECRET}
    domain: ${COGNITO_DOMAIN}
```

#### í™˜ê²½ë³€ìˆ˜ ì„¤ì •
```bash
# AWS Cognito ì„¤ì •
export COGNITO_USER_POOL_ID="ap-northeast-2_xxxxxxxxx"
export COGNITO_CLIENT_ID="xxxxxxxxxxxxxxxxxxxxxxxxxxx"
export COGNITO_CLIENT_SECRET="xxxxxxxxxxxxxxxxxxxxxxxxxxx"
export COGNITO_DOMAIN="team-fog.auth.ap-northeast-2.amazoncognito.com"

# =============================================================================
# Oracle Database ì„¤ì • (ECS EC2 ê¸°ë°˜)
# =============================================================================
export ORACLE_HOST="primarydb.internal"
export ORACLE_PORT="1521"
export ORACLE_SERVICE_NAME="TEAMFOG"
export ORACLE_USERNAME="user_service"
export ORACLE_PASSWORD="secure_password_here"
export ORACLE_STANDBY_HOST="standbydb.internal"
export ORACLE_STANDBY_PORT="1521"
export ORACLE_STANDBY_SERVICE_NAME="TEAMFOG"
export ORACLE_STANDBY_USERNAME="user_service_readonly"
export ORACLE_STANDBY_PASSWORD="secure_password_here"

# MSA ì„œë¹„ìŠ¤ URL
export RESERVATION_SERVICE_URL="http://reservation-service.internal:8080"
export STORE_SERVICE_URL="http://store-service.internal:8081"
export FRONTEND_URL="https://your-frontend-domain.com"
```

### 2. AWS Cognito ì„¤ì •

#### User Pool ìƒì„±
1. AWS Console â†’ Cognito â†’ User Pools â†’ Create user pool
2. Pool name: `team-fog-user-pool`
3. App client ìƒì„±:
   - App client name: `team-fog-client`
   - Callback URLs: `https://your-frontend-domain.com/callback`
   - Sign out URLs: `https://your-frontend-domain.com`

#### App Client ì„¤ì •
```json
{
  "ClientId": "xxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "ClientSecret": "xxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "UserPoolId": "ap-northeast-2_xxxxxxxxx",
  "AllowedOAuthFlows": ["code"],
  "AllowedOAuthScopes": ["openid", "email", "profile"],
  "CallbackURLs": ["https://your-frontend-domain.com/callback"],
  "LogoutURLs": ["https://your-frontend-domain.com"]
}
```

### 3. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •

#### Oracle Database ì„¤ì • (ECS EC2 ê¸°ë°˜ - PDB + Standby)

**Oracle DB ECS ì„œë¹„ìŠ¤ ìƒì„±**:
1. ECS EC2 í´ëŸ¬ìŠ¤í„° ìƒì„±
2. PrimaryDB Task Definition ë“±ë¡
3. StandbyDB Task Definition ë“±ë¡
4. PrimaryDB ì„œë¹„ìŠ¤ ìƒì„±
5. StandbyDB ì„œë¹„ìŠ¤ ìƒì„±
6. ë³´ì•ˆ ê·¸ë£¹ ì„¤ì • (í¬íŠ¸ 1521)
7. EFS ë³¼ë¥¨ ì„¤ì •
8. Data Guard ì„¤ì • (PrimaryDB â†” StandbyDB)

**Oracle DB ì‚¬ìš©ì ë° í…Œì´ë¸” ìƒì„±**:
```sql
-- ì‚¬ìš©ì ìƒì„±
CREATE USER user_service IDENTIFIED BY "secure_password_here";

-- ê¶Œí•œ ë¶€ì—¬
GRANT CONNECT, RESOURCE TO user_service;
GRANT CREATE SESSION TO user_service;
GRANT CREATE TABLE TO user_service;
GRANT CREATE VIEW TO user_service;
GRANT CREATE SEQUENCE TO user_service;

-- í…Œì´ë¸” ìƒì„±
CREATE TABLE users (
    user_id VARCHAR2(15) PRIMARY KEY,
    user_name VARCHAR2(20) NOT NULL,
    phone_number VARCHAR2(20) UNIQUE NOT NULL,
    user_location VARCHAR2(50),
    password VARCHAR2(255) NOT NULL,
    is_active NUMBER(1) DEFAULT 1 NOT NULL,
    created_at TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    updated_at TIMESTAMP
);

CREATE TABLE mv_fav_store (
    fav_store_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id VARCHAR2(15) NOT NULL,
    store_id VARCHAR2(20) NOT NULL,
    created_at TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CONSTRAINT fav_store_un UNIQUE (user_id, store_id)
);

-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_users_phone ON users(phone_number);
CREATE INDEX idx_fav_store_user ON mv_fav_store(user_id);
CREATE INDEX idx_fav_store_store ON mv_fav_store(store_id);
```

### 4. AWS ECS ë°°í¬

#### ECR ë¦¬í¬ì§€í† ë¦¬ ìƒì„±
```bash
aws ecr create-repository --repository-name user-service --region ap-northeast-2
```

#### Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
```bash
# ë¡œê·¸ì¸
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin YOUR_ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com

# ì´ë¯¸ì§€ ë¹Œë“œ
docker build -t user-service .

# íƒœê·¸
docker tag user-service:latest YOUR_ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com/user-service:latest

# í‘¸ì‹œ
docker push YOUR_ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com/user-service:latest
```

#### ECS ì„œë¹„ìŠ¤ ìƒì„±
```bash
# Task Definition ë“±ë¡
aws ecs register-task-definition --cli-input-json file://aws/ecs-task-definition.json

# ì„œë¹„ìŠ¤ ìƒì„±
aws ecs create-service \
  --cluster your-cluster \
  --service-name user-service \
  --task-definition user-service:1 \
  --desired-count 2 \
  --launch-type FARGATE \
  --network-configuration "awsvpcConfiguration={subnets=[subnet-xxxxx,subnet-yyyyy],securityGroups=[sg-xxxxx],assignPublicIp=ENABLED}"
```

### 5. ë³´ì•ˆ ì„¤ì •

#### IAM ì—­í•  ìƒì„±
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": [
        "arn:aws:secretsmanager:ap-northeast-2:YOUR_ACCOUNT_ID:secret:user-service/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "*"
    }
  ]
}
```

#### Secrets Manager ì„¤ì •
```bash
# Oracle Database ë¹„ë°€ë²ˆí˜¸
aws secretsmanager create-secret \
  --name user-service/oracle-password \
  --secret-string "your-oracle-password"

# Oracle DB ê´€ë ¨ Secrets
aws secretsmanager create-secret \
  --name primarydb/password \
  --secret-string "Oracle123456"

aws secretsmanager create-secret \
  --name standbydb/password \
  --secret-string "Oracle123456"

# Cognito Client Secret
aws secretsmanager create-secret \
  --name user-service/cognito-client-secret \
  --secret-string "your-cognito-client-secret"
```

## ğŸ”„ ì½”ë“œ ë³€ê²½ì‚¬í•­

### 1. ë”ë¯¸ ëª¨ë“œ ì œê±°
```java
// UserController.javaì—ì„œ ë”ë¯¸ ëª¨ë“œ ì²´í¬ ì œê±°
if (cognitoConfig.isDummyMode()) {
    // ì´ ë¶€ë¶„ ì œê±°
}
```

### 2. ì‹¤ì œ ì„œë¹„ìŠ¤ ì—°ë™
```java
// Store Service ì—°ë™
List<ReviewDto> reviews = storeServiceIntegration.getUserReviews(userId);
Map<String, Object> storeInfo = storeServiceIntegration.getStoreInfoForReview(reviewId);
```

### 3. ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™
```java
// ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©
User user = userService.getUserInfo(userId);
List<FavoriteStoreDto> favorites = userService.getFavoriteStores(userId);
```

## ğŸ§ª í…ŒìŠ¤íŠ¸

### 1. ë¡œì»¬ í…ŒìŠ¤íŠ¸
```bash
# í”„ë¡œë•ì…˜ í”„ë¡œíŒŒì¼ë¡œ ì‹¤í–‰
SPRING_PROFILES_ACTIVE=prod ./gradlew bootRun
```

### 2. API í…ŒìŠ¤íŠ¸
```bash
# Cognito ë¡œê·¸ì¸
curl -X GET "https://team-fog.auth.ap-northeast-2.amazoncognito.com/oauth2/authorize?response_type=code&client_id=YOUR_CLIENT_ID&redirect_uri=https://your-frontend-domain.com/callback&scope=openid+email+profile"

# í† í°ìœ¼ë¡œ API í˜¸ì¶œ
curl -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  http://localhost:8082/api/users/me
```

## ğŸ“Š ëª¨ë‹ˆí„°ë§

### 1. CloudWatch ë¡œê·¸
```bash
# ë¡œê·¸ ê·¸ë£¹ í™•ì¸
aws logs describe-log-groups --log-group-name-prefix "/ecs/user-service"
```

### 2. ë©”íŠ¸ë¦­ ëª¨ë‹ˆí„°ë§
- CPU ì‚¬ìš©ë¥ 
- ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ 
- API ì‘ë‹µ ì‹œê°„
- ì—ëŸ¬ìœ¨

## ğŸš¨ ë¬¸ì œ í•´ê²°

### 1. Cognito ì—°ê²° ì‹¤íŒ¨
- User Pool ID, Client ID í™•ì¸
- ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ ê·¸ë£¹ ì„¤ì • í™•ì¸
- IAM ê¶Œí•œ í™•ì¸

### 2. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨
- Oracle DB ECS ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
- PrimaryDB/StandbyDB ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
- ë³´ì•ˆ ê·¸ë£¹ ì„¤ì • í™•ì¸ (í¬íŠ¸ 1521)
- ë°ì´í„°ë² ì´ìŠ¤ ìê²© ì¦ëª… í™•ì¸
- PDB ì—°ê²° í™•ì¸

### 3. ì„œë¹„ìŠ¤ ê°„ í†µì‹  ì‹¤íŒ¨
- ì„œë¹„ìŠ¤ URL í™•ì¸
- ë„¤íŠ¸ì›Œí¬ ì„¤ì • í™•ì¸
- ì„œí‚· ë¸Œë ˆì´ì»¤ ì„¤ì • í™•ì¸

## ğŸ“ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] AWS Cognito User Pool ìƒì„±
- [ ] App Client ì„¤ì •
- [ ] PrimaryDB ECS ì„œë¹„ìŠ¤ ìƒì„±
- [ ] StandbyDB ECS ì„œë¹„ìŠ¤ ìƒì„±
- [ ] Data Guard ì„¤ì •
- [ ] í™˜ê²½ë³€ìˆ˜ ì„¤ì •
- [ ] Docker ì´ë¯¸ì§€ ë¹Œë“œ
- [ ] ECR í‘¸ì‹œ
- [ ] ECS ì„œë¹„ìŠ¤ ë°°í¬
- [ ] ë³´ì•ˆ ê·¸ë£¹ ì„¤ì •
- [ ] IAM ì—­í•  ì„¤ì •
- [ ] Secrets Manager ì„¤ì •
- [ ] API í…ŒìŠ¤íŠ¸
- [ ] ëª¨ë‹ˆí„°ë§ ì„¤ì •
