# ğŸš€ Team-FOG User Service ë°°í¬ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

ì´ ë¬¸ì„œëŠ” Team-FOG User Serviceë¥¼ AWS ECS í™˜ê²½ì—ì„œ ì‹¤ì œ ì„œë¹„ìŠ¤ë¡œ ë°°í¬í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

## ğŸ—ï¸ **í˜„ì¬ íŒ€ ìƒí™©**

### **í”„ë¡œì íŠ¸ êµ¬ì¡°**
- **User Service**: ì‚¬ìš©ì ì¸ì¦, íšŒì›ê°€ì…, ë§ˆì´í˜ì´ì§€ (í¬íŠ¸: 8082)
- **Store Service**: ê°€ê²Œ ê´€ë¦¬, ë¦¬ë·° ì‹œìŠ¤í…œ (í¬íŠ¸: 8081)
- **Reservation Service**: ì˜ˆì•½ ê´€ë¦¬, ëŒ€ê¸°ì—´ (í¬íŠ¸: 8080)

### **ê¸°ìˆ  ìŠ¤íƒ**
- **Backend**: Spring Boot 3.5.4, Java 17
- **Database**: Oracle PDB + Standby
- **Cloud**: AWS ECS Fargate
- **Authentication**: AWS Cognito

### **íŒ€ êµ¬ì„±**
- **User Service ë‹´ë‹¹ì**: ì‚¬ìš©ì ì¸ì¦/ì¸ê°€, ë§ˆì´í˜ì´ì§€
- **Store Service ë‹´ë‹¹ì**: ê°€ê²Œ ê´€ë¦¬, ë¦¬ë·° ì‹œìŠ¤í…œ
- **Reservation Service ë‹´ë‹¹ì**: ì˜ˆì•½ ê´€ë¦¬, ëŒ€ê¸°ì—´
- **DevOps ë‹´ë‹¹ì**: AWS ì¸í”„ë¼, ë°°í¬ ê´€ë¦¬

## ğŸ”§ ë”ë¯¸ ëª¨ë“œì—ì„œ ì‹¤ì œ ì„œë¹„ìŠ¤ë¡œ ì „í™˜

### 1. ì„¤ì • íŒŒì¼ ë³€ê²½

#### application.yml ìˆ˜ì •
```yaml
aws:
  cognito:
    dummy-mode: false  # ì‹¤ì œ Cognito ì‚¬ìš©
    user-pool-id: ${COGNITO_USER_POOL_ID}
    client-id: ${COGNITO_CLIENT_ID}
    client-secret: ${COGNITO_CLIENT_SECRET}
    domain: ${COGNITO_DOMAIN}
```

#### í™˜ê²½ë³€ìˆ˜ ì„¤ì •
```bash
# AWS Cognito ì„¤ì •
export COGNITO_USER_POOL_ID="ap-northeast-2_xxxxxxxxx"
export COGNITO_CLIENT_ID="xxxxxxxxxxxxxxxxxxxxxxxxxxx"
export COGNITO_CLIENT_SECRET="xxxxxxxxxxxxxxxxxxxxxxxxxxx"
export COGNITO_DOMAIN="team-fog.auth.ap-northeast-2.amazoncognito.com"

# =============================================================================
# Oracle Database ì„¤ì • (ECS EC2 ê¸°ë°˜)
# =============================================================================
export ORACLE_HOST="primarydb.internal"
export ORACLE_PORT="1521"
export ORACLE_SERVICE_NAME="TEAMFOG"
export ORACLE_USERNAME="user_service"
export ORACLE_PASSWORD="secure_password_here"
export ORACLE_STANDBY_HOST="standbydb.internal"
export ORACLE_STANDBY_PORT="1521"
export ORACLE_STANDBY_SERVICE_NAME="TEAMFOG"
export ORACLE_STANDBY_USERNAME="user_service_readonly"
export ORACLE_STANDBY_PASSWORD="secure_password_here"

# MSA ì„œë¹„ìŠ¤ URL
export RESERVATION_SERVICE_URL="http://reservation-service.internal:8080"
export STORE_SERVICE_URL="http://store-service.internal:8081"
export FRONTEND_URL="https://your-frontend-domain.com"
```

### 2. AWS Cognito ì„¤ì •

#### User Pool ìƒì„±
1. AWS Console â†’ Cognito â†’ User Pools â†’ Create user pool
2. Pool name: `team-fog-user-pool`
3. App client ìƒì„±:
   - App client name: `team-fog-client`
   - Callback URLs: `https://your-frontend-domain.com/callback`
   - Sign out URLs: `https://your-frontend-domain.com`

#### App Client ì„¤ì •
```json
{
  "ClientId": "xxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "ClientSecret": "xxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "UserPoolId": "ap-northeast-2_xxxxxxxxx",
  "AllowedOAuthFlows": ["code"],
  "AllowedOAuthScopes": ["openid", "email", "profile"],
  "CallbackURLs": ["https://your-frontend-domain.com/callback"],
  "LogoutURLs": ["https://your-frontend-domain.com"]
}
```

### 3. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •

#### Oracle Database ì„¤ì • (ECS EC2 ê¸°ë°˜ - PDB + Standby)

**Oracle DB ECS ì„œë¹„ìŠ¤ ìƒì„±**:
1. ECS EC2 í´ëŸ¬ìŠ¤í„° ìƒì„±
2. PrimaryDB Task Definition ë“±ë¡
3. StandbyDB Task Definition ë“±ë¡
4. PrimaryDB ì„œë¹„ìŠ¤ ìƒì„±
5. StandbyDB ì„œë¹„ìŠ¤ ìƒì„±
6. ë³´ì•ˆ ê·¸ë£¹ ì„¤ì • (í¬íŠ¸ 1521)
7. EFS ë³¼ë¥¨ ì„¤ì •
8. Data Guard ì„¤ì • (PrimaryDB â†” StandbyDB)

**Oracle DB ì‚¬ìš©ì ë° í…Œì´ë¸” ìƒì„±**:
```sql
-- ì‚¬ìš©ì ìƒì„±
CREATE USER user_service IDENTIFIED BY "secure_password_here";

-- ê¶Œí•œ ë¶€ì—¬
GRANT CONNECT, RESOURCE TO user_service;
GRANT CREATE SESSION TO user_service;
GRANT CREATE TABLE TO user_service;
GRANT CREATE VIEW TO user_service;
GRANT CREATE SEQUENCE TO user_service;

-- í…Œì´ë¸” ìƒì„±
CREATE TABLE users (
    user_id VARCHAR2(15) PRIMARY KEY,
    user_name VARCHAR2(20) NOT NULL,
    phone_number VARCHAR2(20) UNIQUE NOT NULL,
    user_location VARCHAR2(50),
    password VARCHAR2(255) NOT NULL,
    is_active NUMBER(1) DEFAULT 1 NOT NULL,
    created_at TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    updated_at TIMESTAMP
);

CREATE TABLE fav_store (
    fav_store_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id VARCHAR2(15) NOT NULL,
    store_id2 VARCHAR2(20) NOT NULL,
    created_at TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CONSTRAINT fav_store_un UNIQUE (user_id, store_id2)
);

-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_users_phone ON users(phone_number);
CREATE INDEX idx_fav_store_user ON fav_store(user_id);
CREATE INDEX idx_fav_store_store ON fav_store(store_id2);
```

## ğŸš€ AWS ECS ë°°í¬

### 1. ECR ë¦¬í¬ì§€í† ë¦¬ ìƒì„±
```bash
# ECR ë¦¬í¬ì§€í† ë¦¬ ìƒì„±
aws ecr create-repository --repository-name team-fog-user-service

# ECR ë¡œê·¸ì¸
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com
```

### 2. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
```bash
# Docker ì´ë¯¸ì§€ ë¹Œë“œ
docker build -t team-fog-user-service:latest .

# ì´ë¯¸ì§€ íƒœê·¸
docker tag team-fog-user-service:latest ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com/team-fog-user-service:latest

# ì´ë¯¸ì§€ í‘¸ì‹œ
docker push ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com/team-fog-user-service:latest
```

### 3. ECS Task Definition ë“±ë¡
```bash
# Task Definition ë“±ë¡
aws ecs register-task-definition --cli-input-json file://aws/user-service-task-definition.json
```

### 4. ECS ì„œë¹„ìŠ¤ ìƒì„±
```bash
# ECS ì„œë¹„ìŠ¤ ìƒì„±
aws ecs create-service \
    --cluster team-fog-cluster \
    --service-name user-service \
    --task-definition user-service-task \
    --desired-count 2 \
    --launch-type FARGATE \
    --network-configuration "awsvpcConfiguration={subnets=[subnet-xxxxx,subnet-yyyyy],securityGroups=[sg-xxxxx],assignPublicIp=ENABLED}"
```

## ğŸ” ë°°í¬ í™•ì¸

### 1. ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
```bash
# ECS ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
aws ecs describe-services \
    --cluster team-fog-cluster \
    --services user-service

# ë¡œê·¸ í™•ì¸
aws logs tail /ecs/user-service --follow
```

### 2. API í…ŒìŠ¤íŠ¸
```bash
# í—¬ìŠ¤ì²´í¬
curl -X GET "http://user-service.internal:8082/api/users/health"

# ë”ë¯¸ ë¡œê·¸ì¸ (ê°œë°œìš©)
curl -X GET "http://user-service.internal:8082/api/users/login/dummy?state=test-state"
```

## ğŸš¨ ë¬¸ì œ í•´ê²°

### 1. ë°°í¬ ì‹¤íŒ¨ ì‹œ
```bash
# ì„œë¹„ìŠ¤ ì´ë²¤íŠ¸ í™•ì¸
aws ecs describe-services \
    --cluster team-fog-cluster \
    --services user-service \
    --query 'services[0].events'

# íƒœìŠ¤í¬ ë¡œê·¸ í™•ì¸
aws logs tail /ecs/user-service --follow
```

### 2. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨
```bash
# Oracle DB ì—°ê²° í…ŒìŠ¤íŠ¸
sqlplus user_service/secure_password_here@primarydb.internal:1521/TEAMFOG

# ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸
telnet primarydb.internal 1521
```

### 3. Cognito ì—°ê²° ì‹¤íŒ¨
```bash
# Cognito ì„¤ì • í™•ì¸
aws cognito-idp describe-user-pool --user-pool-id ap-northeast-2_xxxxxxxxx

# App Client ì„¤ì • í™•ì¸
aws cognito-idp describe-user-pool-client \
    --user-pool-id ap-northeast-2_xxxxxxxxx \
    --client-id xxxxxxxxxxxxxxxxxxxxxxxxxxx
```

## ğŸ“ ì§€ì›

- **ë‹´ë‹¹ì**: User Service ë‹´ë‹¹ì
- **ì´ë©”ì¼**: user-service@team-fog.com
- **ìŠ¬ë™**: #user-service

---

ì´ ê°€ì´ë“œë¥¼ ë”°ë¼ User Serviceë¥¼ ì„±ê³µì ìœ¼ë¡œ ë°°í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸš€
