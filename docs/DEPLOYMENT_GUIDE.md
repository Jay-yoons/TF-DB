# 🚀 Team-FOG User Service 배포 가이드

## 📋 개요

이 문서는 Team-FOG User Service를 AWS ECS 환경에서 실제 서비스로 배포하는 방법을 설명합니다.

## 🏗️ **현재 팀 상황**

### **프로젝트 구조**
- **User Service**: 사용자 인증, 회원가입, 마이페이지 (포트: 8082)
- **Store Service**: 가게 관리, 리뷰 시스템 (포트: 8081)
- **Reservation Service**: 예약 관리, 대기열 (포트: 8080)

### **기술 스택**
- **Backend**: Spring Boot 3.5.4, Java 17
- **Database**: Oracle PDB + Standby
- **Cloud**: AWS ECS Fargate
- **Authentication**: AWS Cognito

### **팀 구성**
- **User Service 담당자**: 사용자 인증/인가, 마이페이지
- **Store Service 담당자**: 가게 관리, 리뷰 시스템
- **Reservation Service 담당자**: 예약 관리, 대기열
- **DevOps 담당자**: AWS 인프라, 배포 관리

## 🔧 더미 모드에서 실제 서비스로 전환

### 1. 설정 파일 변경

#### application.yml 수정
```yaml
aws:
  cognito:
    dummy-mode: false  # 실제 Cognito 사용
    user-pool-id: ${COGNITO_USER_POOL_ID}
    client-id: ${COGNITO_CLIENT_ID}
    client-secret: ${COGNITO_CLIENT_SECRET}
    domain: ${COGNITO_DOMAIN}
```

#### 환경변수 설정
```bash
# AWS Cognito 설정
export COGNITO_USER_POOL_ID="ap-northeast-2_xxxxxxxxx"
export COGNITO_CLIENT_ID="xxxxxxxxxxxxxxxxxxxxxxxxxxx"
export COGNITO_CLIENT_SECRET="xxxxxxxxxxxxxxxxxxxxxxxxxxx"
export COGNITO_DOMAIN="team-fog.auth.ap-northeast-2.amazoncognito.com"

# =============================================================================
# Oracle Database 설정 (ECS EC2 기반)
# =============================================================================
export ORACLE_HOST="primarydb.internal"
export ORACLE_PORT="1521"
export ORACLE_SERVICE_NAME="TEAMFOG"
export ORACLE_USERNAME="user_service"
export ORACLE_PASSWORD="secure_password_here"
export ORACLE_STANDBY_HOST="standbydb.internal"
export ORACLE_STANDBY_PORT="1521"
export ORACLE_STANDBY_SERVICE_NAME="TEAMFOG"
export ORACLE_STANDBY_USERNAME="user_service_readonly"
export ORACLE_STANDBY_PASSWORD="secure_password_here"

# MSA 서비스 URL
export RESERVATION_SERVICE_URL="http://reservation-service.internal:8080"
export STORE_SERVICE_URL="http://store-service.internal:8081"
export FRONTEND_URL="https://your-frontend-domain.com"
```

### 2. AWS Cognito 설정

#### User Pool 생성
1. AWS Console → Cognito → User Pools → Create user pool
2. Pool name: `team-fog-user-pool`
3. App client 생성:
   - App client name: `team-fog-client`
   - Callback URLs: `https://your-frontend-domain.com/callback`
   - Sign out URLs: `https://your-frontend-domain.com`

#### App Client 설정
```json
{
  "ClientId": "xxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "ClientSecret": "xxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "UserPoolId": "ap-northeast-2_xxxxxxxxx",
  "AllowedOAuthFlows": ["code"],
  "AllowedOAuthScopes": ["openid", "email", "profile"],
  "CallbackURLs": ["https://your-frontend-domain.com/callback"],
  "LogoutURLs": ["https://your-frontend-domain.com"]
}
```

### 3. 데이터베이스 설정

#### Oracle Database 설정 (ECS EC2 기반 - PDB + Standby)

**Oracle DB ECS 서비스 생성**:
1. ECS EC2 클러스터 생성
2. PrimaryDB Task Definition 등록
3. StandbyDB Task Definition 등록
4. PrimaryDB 서비스 생성
5. StandbyDB 서비스 생성
6. 보안 그룹 설정 (포트 1521)
7. EFS 볼륨 설정
8. Data Guard 설정 (PrimaryDB ↔ StandbyDB)

**Oracle DB 사용자 및 테이블 생성**:
```sql
-- 사용자 생성
CREATE USER user_service IDENTIFIED BY "secure_password_here";

-- 권한 부여
GRANT CONNECT, RESOURCE TO user_service;
GRANT CREATE SESSION TO user_service;
GRANT CREATE TABLE TO user_service;
GRANT CREATE VIEW TO user_service;
GRANT CREATE SEQUENCE TO user_service;

-- 테이블 생성
CREATE TABLE users (
    user_id VARCHAR2(15) PRIMARY KEY,
    user_name VARCHAR2(20) NOT NULL,
    phone_number VARCHAR2(20) UNIQUE NOT NULL,
    user_location VARCHAR2(50),
    password VARCHAR2(255) NOT NULL,
    is_active NUMBER(1) DEFAULT 1 NOT NULL,
    created_at TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    updated_at TIMESTAMP
);

CREATE TABLE fav_store (
    fav_store_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id VARCHAR2(15) NOT NULL,
    store_id2 VARCHAR2(20) NOT NULL,
    created_at TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CONSTRAINT fav_store_un UNIQUE (user_id, store_id2)
);

-- 인덱스 생성
CREATE INDEX idx_users_phone ON users(phone_number);
CREATE INDEX idx_fav_store_user ON fav_store(user_id);
CREATE INDEX idx_fav_store_store ON fav_store(store_id2);
```

## 🚀 AWS ECS 배포

### 1. ECR 리포지토리 생성
```bash
# ECR 리포지토리 생성
aws ecr create-repository --repository-name team-fog-user-service

# ECR 로그인
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com
```

### 2. Docker 이미지 빌드 및 푸시
```bash
# Docker 이미지 빌드
docker build -t team-fog-user-service:latest .

# 이미지 태그
docker tag team-fog-user-service:latest ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com/team-fog-user-service:latest

# 이미지 푸시
docker push ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com/team-fog-user-service:latest
```

### 3. ECS Task Definition 등록
```bash
# Task Definition 등록
aws ecs register-task-definition --cli-input-json file://aws/user-service-task-definition.json
```

### 4. ECS 서비스 생성
```bash
# ECS 서비스 생성
aws ecs create-service \
    --cluster team-fog-cluster \
    --service-name user-service \
    --task-definition user-service-task \
    --desired-count 2 \
    --launch-type FARGATE \
    --network-configuration "awsvpcConfiguration={subnets=[subnet-xxxxx,subnet-yyyyy],securityGroups=[sg-xxxxx],assignPublicIp=ENABLED}"
```

## 🔍 배포 확인

### 1. 서비스 상태 확인
```bash
# ECS 서비스 상태 확인
aws ecs describe-services \
    --cluster team-fog-cluster \
    --services user-service

# 로그 확인
aws logs tail /ecs/user-service --follow
```

### 2. API 테스트
```bash
# 헬스체크
curl -X GET "http://user-service.internal:8082/api/users/health"

# 더미 로그인 (개발용)
curl -X GET "http://user-service.internal:8082/api/users/login/dummy?state=test-state"
```

## 🚨 문제 해결

### 1. 배포 실패 시
```bash
# 서비스 이벤트 확인
aws ecs describe-services \
    --cluster team-fog-cluster \
    --services user-service \
    --query 'services[0].events'

# 태스크 로그 확인
aws logs tail /ecs/user-service --follow
```

### 2. 데이터베이스 연결 실패
```bash
# Oracle DB 연결 테스트
sqlplus user_service/secure_password_here@primarydb.internal:1521/TEAMFOG

# 네트워크 연결 확인
telnet primarydb.internal 1521
```

### 3. Cognito 연결 실패
```bash
# Cognito 설정 확인
aws cognito-idp describe-user-pool --user-pool-id ap-northeast-2_xxxxxxxxx

# App Client 설정 확인
aws cognito-idp describe-user-pool-client \
    --user-pool-id ap-northeast-2_xxxxxxxxx \
    --client-id xxxxxxxxxxxxxxxxxxxxxxxxxxx
```

## 📞 지원

- **담당자**: User Service 담당자
- **이메일**: user-service@team-fog.com
- **슬랙**: #user-service

---

이 가이드를 따라 User Service를 성공적으로 배포할 수 있습니다! 🚀
