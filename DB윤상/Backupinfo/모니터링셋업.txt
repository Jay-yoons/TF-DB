모니터링 작업은 우선 EMPress ASHviewer ASH, AWR 와 Zabbix 를 사용할 예정

용도
EM Express
GUI로 성능 모니터링 SQL 튜닝 목적

ASH
OracleDB 세션 샘플링 기록 성능 데이터
어떤 SQL이 LOCK 걸렸는지 확인 가능

ASH Viewer
실시간 ASH 뷰어 GUI로 보기 쉽게 하는툴

AWR
선능 통계 스냅샷 저장하는 용도

Zabbix
OS 리소스 모니터링

모니터링개요

멘토님의 EM Express를 사용하는 것을 권장 하여 

설정을 진행 하지만 PDB가 3개 이기에 같은 포트 5500을 사용 할수 없는 상황 따라서

쉘 스크립트로 5500을 지정 할수 있게 변경

```bash
#!/bin/bash

PDB_NAME=$1
ACTION=$2

case "$PDB_NAME" in
  CDB)
    CONTAINER="CDB$ROOT"
    ;;
  STORE)
    CONTAINER="PDB_STORE"
    ;;
  BOOKING)
    CONTAINER="PDB_BOOKING"
    ;;
  USER)
    CONTAINER="PDB_USER"
    ;;
  *)
    echo "Unknown PDB: $PDB_NAME"
    exit 1
    ;;
esac

case "$ACTION" in
  start)
    PORT=5500
    ;;
  stop)
    PORT=0
    ;;

  *)
    **echo "Unknown PDB: $PDB_NAME"
    exit 1
    ;;
esac

case "$ACTION" in
  start)
    PORT=5500
    ;;
  stop)
    PORT=0
    ;;
  *)
    echo "Unknown action: $ACTION"
    exit 1
    ;;
esac

sqlplus / as sysdba <<EOF
ALTER SESSION SET CONTAINER=$CONTAINER;
BEGIN
  DBMS_XDB_CONFIG.SETHTTPSPORT($PORT);
END;
/
EXIT;
EOF

```

상기 쉘스크립트를 통해 변경이 가능하며,

해당 웹은 Nginx로 사용한다.

Zabbix DB 리소스 모니터링이며,

이를 설치하기 위해서는 웹사이트에 들어가 확인이 가능하다.

리소스의 대한 정보들이 표시 되며 이를 통해 DB 리소스를 많이 먹을시 EM 으로 확인이 가능

ASH sqlplus에서 직접 접속에서 뷰를 보는 방식이며,

select

| sample_id,sample_time, | 샘플링이 일어난 시간과 샘플 ID |
| --- | --- |
| session_id,session_serial#,user_id,xid, | 세션정보, User명, 트랜잭션 ID |
| sql_id,sql_child_number,sql_plan_hash_value, |  수행중 SQL정보 |
| session_state, | 현재 세션의 상태 정보, 'ON CPU' 또는 'WAITING’ |
| qc_instance_id, qc_session_id, | 병렬 Slave 세션일때 쿼리 코디네이터 정보를 찾을 수 있게 함 |
| blocking_session, blocking_session_serial#,blocking_session_status, | 현재 세션의 진행을 막고 있는 블로킹 세션 정보 |
| event,event#,seq#,wait_class,wait_time,time_waited, | 현재 발생 중인 대기 이벤트 정보 |
| p1text,p1,p2text,p2,p3text,p3, | 현재 발생 중인 대기 이벤트의 파라미터 정보 |
| current_obj#,current_file#,current_block#, | 해당 세션이 현재 참조하고 있는 오브젝트 정보. v$session뷰에 있는 row-wait_obj#,row_wait_file#,row_wait_block#컬럼을 가져온 것임 |
| program,module,action,client_id | 애플리케이션 정보 |

from v$active_session_history;

상기와 같이 ASH를 쿼리를 수행 하여 확인할수 있다.

AWR

@?/rdbms/admin/awrrpt.sql 를 통해 생성하며 1시간 주기로 스냅샷을 찍어 DB 내부로 저장하여 확인 한다. 이 AWR은 장기적으로 DB의 이상점을 확인 하기에 운영 환경에서 사용을 할 예정

@?/rdbms/admin/awrrpt.sql 이것을 통해 확인
