# 🚀 User Service 배포 가이드

## 📋 개요

이 문서는 User Service를 AWS MSA 환경에서 실제 서비스로 배포하는 방법을 설명합니다.

## 🔧 더미 모드에서 실제 서비스로 전환

### 1. 설정 파일 변경

#### application.yml 수정
```yaml
aws:
  cognito:
    dummy-mode: false  # 실제 Cognito 사용
    user-pool-id: ${COGNITO_USER_POOL_ID}
    client-id: ${COGNITO_CLIENT_ID}
    client-secret: ${COGNITO_CLIENT_SECRET}
    domain: ${COGNITO_DOMAIN}
```

#### 환경변수 설정
```bash
# AWS Cognito 설정
export COGNITO_USER_POOL_ID="ap-northeast-2_xxxxxxxxx"
export COGNITO_CLIENT_ID="xxxxxxxxxxxxxxxxxxxxxxxxxxx"
export COGNITO_CLIENT_SECRET="xxxxxxxxxxxxxxxxxxxxxxxxxxx"
export COGNITO_DOMAIN="team-fog.auth.ap-northeast-2.amazoncognito.com"

# =============================================================================
# Oracle Database 설정 (ECS EC2 기반)
# =============================================================================
export ORACLE_HOST="primarydb.internal"
export ORACLE_PORT="1521"
export ORACLE_SERVICE_NAME="TEAMFOG"
export ORACLE_USERNAME="user_service"
export ORACLE_PASSWORD="secure_password_here"
export ORACLE_STANDBY_HOST="standbydb.internal"
export ORACLE_STANDBY_PORT="1521"
export ORACLE_STANDBY_SERVICE_NAME="TEAMFOG"
export ORACLE_STANDBY_USERNAME="user_service_readonly"
export ORACLE_STANDBY_PASSWORD="secure_password_here"

# MSA 서비스 URL
export RESERVATION_SERVICE_URL="http://reservation-service.internal:8080"
export STORE_SERVICE_URL="http://store-service.internal:8081"
export FRONTEND_URL="https://your-frontend-domain.com"
```

### 2. AWS Cognito 설정

#### User Pool 생성
1. AWS Console → Cognito → User Pools → Create user pool
2. Pool name: `team-fog-user-pool`
3. App client 생성:
   - App client name: `team-fog-client`
   - Callback URLs: `https://your-frontend-domain.com/callback`
   - Sign out URLs: `https://your-frontend-domain.com`

#### App Client 설정
```json
{
  "ClientId": "xxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "ClientSecret": "xxxxxxxxxxxxxxxxxxxxxxxxxxx",
  "UserPoolId": "ap-northeast-2_xxxxxxxxx",
  "AllowedOAuthFlows": ["code"],
  "AllowedOAuthScopes": ["openid", "email", "profile"],
  "CallbackURLs": ["https://your-frontend-domain.com/callback"],
  "LogoutURLs": ["https://your-frontend-domain.com"]
}
```

### 3. 데이터베이스 설정

#### Oracle Database 설정 (ECS EC2 기반 - PDB + Standby)

**Oracle DB ECS 서비스 생성**:
1. ECS EC2 클러스터 생성
2. PrimaryDB Task Definition 등록
3. StandbyDB Task Definition 등록
4. PrimaryDB 서비스 생성
5. StandbyDB 서비스 생성
6. 보안 그룹 설정 (포트 1521)
7. EFS 볼륨 설정
8. Data Guard 설정 (PrimaryDB ↔ StandbyDB)

**Oracle DB 사용자 및 테이블 생성**:
```sql
-- 사용자 생성
CREATE USER user_service IDENTIFIED BY "secure_password_here";

-- 권한 부여
GRANT CONNECT, RESOURCE TO user_service;
GRANT CREATE SESSION TO user_service;
GRANT CREATE TABLE TO user_service;
GRANT CREATE VIEW TO user_service;
GRANT CREATE SEQUENCE TO user_service;

-- 테이블 생성
CREATE TABLE users (
    user_id VARCHAR2(15) PRIMARY KEY,
    user_name VARCHAR2(20) NOT NULL,
    phone_number VARCHAR2(20) UNIQUE NOT NULL,
    user_location VARCHAR2(50),
    password VARCHAR2(255) NOT NULL,
    is_active NUMBER(1) DEFAULT 1 NOT NULL,
    created_at TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    updated_at TIMESTAMP
);

CREATE TABLE mv_fav_store (
    fav_store_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id VARCHAR2(15) NOT NULL,
    store_id VARCHAR2(20) NOT NULL,
    created_at TIMESTAMP DEFAULT SYSTIMESTAMP NOT NULL,
    CONSTRAINT fav_store_un UNIQUE (user_id, store_id)
);

-- 인덱스 생성
CREATE INDEX idx_users_phone ON users(phone_number);
CREATE INDEX idx_fav_store_user ON mv_fav_store(user_id);
CREATE INDEX idx_fav_store_store ON mv_fav_store(store_id);
```

### 4. AWS ECS 배포

#### ECR 리포지토리 생성
```bash
aws ecr create-repository --repository-name user-service --region ap-northeast-2
```

#### Docker 이미지 빌드 및 푸시
```bash
# 로그인
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin YOUR_ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com

# 이미지 빌드
docker build -t user-service .

# 태그
docker tag user-service:latest YOUR_ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com/user-service:latest

# 푸시
docker push YOUR_ACCOUNT_ID.dkr.ecr.ap-northeast-2.amazonaws.com/user-service:latest
```

#### ECS 서비스 생성
```bash
# Task Definition 등록
aws ecs register-task-definition --cli-input-json file://aws/ecs-task-definition.json

# 서비스 생성
aws ecs create-service \
  --cluster your-cluster \
  --service-name user-service \
  --task-definition user-service:1 \
  --desired-count 2 \
  --launch-type FARGATE \
  --network-configuration "awsvpcConfiguration={subnets=[subnet-xxxxx,subnet-yyyyy],securityGroups=[sg-xxxxx],assignPublicIp=ENABLED}"
```

### 5. 보안 설정

#### IAM 역할 생성
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": [
        "arn:aws:secretsmanager:ap-northeast-2:YOUR_ACCOUNT_ID:secret:user-service/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "*"
    }
  ]
}
```

#### Secrets Manager 설정
```bash
# Oracle Database 비밀번호
aws secretsmanager create-secret \
  --name user-service/oracle-password \
  --secret-string "your-oracle-password"

# Oracle DB 관련 Secrets
aws secretsmanager create-secret \
  --name primarydb/password \
  --secret-string "Oracle123456"

aws secretsmanager create-secret \
  --name standbydb/password \
  --secret-string "Oracle123456"

# Cognito Client Secret
aws secretsmanager create-secret \
  --name user-service/cognito-client-secret \
  --secret-string "your-cognito-client-secret"
```

## 🔄 코드 변경사항

### 1. 더미 모드 제거
```java
// UserController.java에서 더미 모드 체크 제거
if (cognitoConfig.isDummyMode()) {
    // 이 부분 제거
}
```

### 2. 실제 서비스 연동
```java
// Store Service 연동
List<ReviewDto> reviews = storeServiceIntegration.getUserReviews(userId);
Map<String, Object> storeInfo = storeServiceIntegration.getStoreInfoForReview(reviewId);
```

### 3. 데이터베이스 연동
```java
// 실제 데이터베이스 사용
User user = userService.getUserInfo(userId);
List<FavoriteStoreDto> favorites = userService.getFavoriteStores(userId);
```

## 🧪 테스트

### 1. 로컬 테스트
```bash
# 프로덕션 프로파일로 실행
SPRING_PROFILES_ACTIVE=prod ./gradlew bootRun
```

### 2. API 테스트
```bash
# Cognito 로그인
curl -X GET "https://team-fog.auth.ap-northeast-2.amazoncognito.com/oauth2/authorize?response_type=code&client_id=YOUR_CLIENT_ID&redirect_uri=https://your-frontend-domain.com/callback&scope=openid+email+profile"

# 토큰으로 API 호출
curl -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  http://localhost:8082/api/users/me
```

## 📊 모니터링

### 1. CloudWatch 로그
```bash
# 로그 그룹 확인
aws logs describe-log-groups --log-group-name-prefix "/ecs/user-service"
```

### 2. 메트릭 모니터링
- CPU 사용률
- 메모리 사용률
- API 응답 시간
- 에러율

## 🚨 문제 해결

### 1. Cognito 연결 실패
- User Pool ID, Client ID 확인
- 네트워크 보안 그룹 설정 확인
- IAM 권한 확인

### 2. 데이터베이스 연결 실패
- Oracle DB ECS 서비스 상태 확인
- PrimaryDB/StandbyDB 엔드포인트 확인
- 보안 그룹 설정 확인 (포트 1521)
- 데이터베이스 자격 증명 확인
- PDB 연결 확인

### 3. 서비스 간 통신 실패
- 서비스 URL 확인
- 네트워크 설정 확인
- 서킷 브레이커 설정 확인

## 📝 체크리스트

- [ ] AWS Cognito User Pool 생성
- [ ] App Client 설정
- [ ] PrimaryDB ECS 서비스 생성
- [ ] StandbyDB ECS 서비스 생성
- [ ] Data Guard 설정
- [ ] 환경변수 설정
- [ ] Docker 이미지 빌드
- [ ] ECR 푸시
- [ ] ECS 서비스 배포
- [ ] 보안 그룹 설정
- [ ] IAM 역할 설정
- [ ] Secrets Manager 설정
- [ ] API 테스트
- [ ] 모니터링 설정
