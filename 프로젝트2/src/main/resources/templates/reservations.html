<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ˆì•½ ê´€ë¦¬ - ë ˆìŠ¤í† ë‘ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        .reservation-card {
            transition: transform 0.2s;
        }
        .reservation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-confirmed {
            color: #28a745;
        }
        .status-cancelled {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">ğŸ½ï¸ ë ˆìŠ¤í† ë‘ ì˜ˆì•½</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/restaurants">ë ˆìŠ¤í† ë‘ ëª©ë¡</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/reservations">ì˜ˆì•½ ê´€ë¦¬</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/mypage">ë§ˆì´í˜ì´ì§€</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item" id="loginSection">
                        <a class="nav-link" href="/login">ë¡œê·¸ì¸</a>
                    </li>
                    <li class="nav-item" id="signupSection">
                        <a class="nav-link" href="/signup">íšŒì›ê°€ì…</a>
                    </li>
                    <li class="nav-item" id="logoutSection" style="display: none;">
                        <a class="nav-link" href="/logout-page">ë¡œê·¸ì•„ì›ƒ</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">ğŸ“… ì˜ˆì•½ ê´€ë¦¬</h2>
                
                <!-- í•„í„° ì˜µì…˜ -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="input-group">
                            <select class="form-select" id="statusFilter">
                                <option value="">ëª¨ë“  ìƒíƒœ</option>
                                <option value="CONFIRMED">í™•ì •</option>
                                <option value="CANCELLED">ì·¨ì†Œ</option>
                            </select>
                            <button class="btn btn-outline-secondary" type="button" onclick="filterReservations()">í•„í„°</button>
                        </div>
                    </div>
                </div>

                <!-- ì˜ˆì•½ ëª©ë¡ -->
                <div id="reservationList">
                    <!-- ì˜ˆì•½ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ì˜ˆì•½ ì·¨ì†Œ í™•ì¸ ëª¨ë‹¬ -->
    <div class="modal fade" id="cancelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ì˜ˆì•½ ì·¨ì†Œ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>ì •ë§ë¡œ ì´ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                    <div id="cancelReservationInfo">
                        <!-- ì˜ˆì•½ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-danger" onclick="confirmCancelReservation()">ì˜ˆì•½ ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentReservation = null;

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        function checkLoginStatus() {
            fetch('/me')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 401) {
                        console.log('ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ');
                        return null;
                    } else {
                        throw new Error('ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨');
                    }
                })
                .then(user => {
                    if (user) {
                        document.getElementById('loginSection').style.display = 'none';
                        document.getElementById('signupSection').style.display = 'none';
                        document.getElementById('logoutSection').style.display = 'block';
                        loadReservations();
                    } else {
                        document.getElementById('loginSection').style.display = 'block';
                        document.getElementById('signupSection').style.display = 'block';
                        document.getElementById('logoutSection').style.display = 'none';
                        document.getElementById('reservationList').innerHTML = '<div class="alert alert-info">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';
                    }
                })
                .catch(error => {
                    console.error('ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                });
        }

        // ì˜ˆì•½ ëª©ë¡ ë¡œë“œ
        function loadReservations() {
            fetch('/api/reservations')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 401) {
                        throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    } else {
                        throw new Error('ì˜ˆì•½ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
                    }
                })
                .then(reservations => {
                    displayReservations(reservations);
                })
                .catch(error => {
                    console.error('ì˜ˆì•½ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                    if (error.message === 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.') {
                        document.getElementById('reservationList').innerHTML = '<div class="alert alert-info">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';
                    } else {
                        document.getElementById('reservationList').innerHTML = '<div class="alert alert-danger">ì˜ˆì•½ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                    }
                });
        }

        // ì˜ˆì•½ ëª©ë¡ í‘œì‹œ
        function displayReservations(reservations) {
            const reservationList = document.getElementById('reservationList');
            
            if (reservations.length === 0) {
                reservationList.innerHTML = '<div class="alert alert-info">ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            reservationList.innerHTML = '';

            reservations.forEach(reservation => {
                const reservationCard = document.createElement('div');
                reservationCard.className = 'col-md-6 col-lg-4 mb-4';
                
                const statusClass = reservation.bookingStateCode === 'CONFIRMED' ? 'status-confirmed' : 'status-cancelled';
                const statusText = reservation.bookingStateCode === 'CONFIRMED' ? 'í™•ì •' : 'ì·¨ì†Œ';
                
                reservationCard.innerHTML = `
                    <div class="card reservation-card h-100">
                        <div class="card-body">
                            <h6 class="card-title">ì˜ˆì•½ #${reservation.bookingNum}</h6>
                            <p class="card-text">
                                <strong>ë ˆìŠ¤í† ë‘:</strong> ${getRestaurantName(reservation.storeId)}<br>
                                <strong>ë‚ ì§œ:</strong> ${formatDate(reservation.bookingDate)}<br>
                                <strong>ì¸ì›:</strong> ${reservation.count}ëª…<br>
                                <strong>ìƒíƒœ:</strong> <span class="${statusClass}">${statusText}</span>
                            </p>
                            ${reservation.bookingStateCode === 'CONFIRMED' ? 
                                `<button class="btn btn-danger btn-sm" onclick="openCancelModal(${reservation.bookingNum}, '${getRestaurantName(reservation.storeId)}', '${formatDate(reservation.bookingDate)}')">
                                    ì˜ˆì•½ ì·¨ì†Œ
                                </button>` : 
                                '<span class="text-muted">ì·¨ì†Œë¨</span>'
                            }
                        </div>
                    </div>
                `;
                reservationList.appendChild(reservationCard);
            });
        }

        // ë ˆìŠ¤í† ë‘ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (ì‹¤ì œë¡œëŠ” API í˜¸ì¶œ)
        function getRestaurantName(storeId) {
            const restaurants = {
                'STORE001': 'ë§›ìˆëŠ” í•œì‹ë‹¹',
                'STORE002': 'ì´íƒˆë¦¬ì•ˆ ë ˆìŠ¤í† ë‘',
                'STORE003': 'ì¼ì‹ ìŠ¤ì‹œë°”',
                'STORE004': 'ì¤‘êµ­ì§‘',
                'STORE005': 'ìŠ¤í…Œì´í¬í•˜ìš°ìŠ¤'
            };
            return restaurants[storeId] || storeId;
        }

        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR');
        }

        // í•„í„°ë§
        function filterReservations() {
            const statusFilter = document.getElementById('statusFilter').value;
            
            fetch('/api/reservations')
                .then(response => response.json())
                .then(reservations => {
                    let filtered = reservations;
                    
                    if (statusFilter) {
                        filtered = reservations.filter(reservation => 
                            reservation.bookingStateCode === statusFilter
                        );
                    }
                    
                    displayReservations(filtered);
                })
                .catch(error => {
                    console.error('í•„í„°ë§ ì˜¤ë¥˜:', error);
                });
        }

        // ì·¨ì†Œ ëª¨ë‹¬ ì—´ê¸°
        function openCancelModal(bookingNum, restaurantName, bookingDate) {
            currentReservation = { bookingNum, restaurantName, bookingDate };
            
            document.getElementById('cancelReservationInfo').innerHTML = `
                <div class="alert alert-warning">
                    <strong>ë ˆìŠ¤í† ë‘:</strong> ${restaurantName}<br>
                    <strong>ë‚ ì§œ:</strong> ${bookingDate}
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('cancelModal'));
            modal.show();
        }

        // ì˜ˆì•½ ì·¨ì†Œ í™•ì¸
        function confirmCancelReservation() {
            if (!currentReservation) {
                alert('ì·¨ì†Œí•  ì˜ˆì•½ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            fetch(`/api/reservations/${currentReservation.bookingNum}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    alert('ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('cancelModal'));
                    modal.hide();
                    loadReservations(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('ì˜ˆì•½ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('ì˜ˆì•½ ì·¨ì†Œ ì˜¤ë¥˜:', error);
                alert('ì˜ˆì•½ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });
    </script>
</body>
</html> 