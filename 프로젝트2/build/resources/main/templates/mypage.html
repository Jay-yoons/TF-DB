<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이페이지 - 레스토랑 예약 시스템</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        .mypage-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 0;
        }
        .mypage-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .booking-card {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        .booking-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.8em;
        }
        .nav-tabs .nav-link {
            color: #667eea;
        }
        .nav-tabs .nav-link.active {
            background-color: #667eea;
            color: white;
        }
        .profile-section {
            text-align: center;
            padding: 20px;
        }
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 2rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-utensils me-2"></i>레스토랑 예약
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">홈</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/restaurants">레스토랑</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/reservations">예약</a>
                    </li>
                </ul>
                <ul class="navbar-nav" id="authNav">
                    <!-- 로그인 상태에 따라 동적으로 변경됨 -->
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="mypage-section">
        <div class="container text-center">
            <h1 class="display-4 fw-bold mb-4">마이페이지</h1>
            <p class="lead mb-5">내 예약과 정보를 관리하세요</p>
        </div>
    </section>

    <!-- Main Content -->
    <section class="py-5">
        <div class="container">
            <div class="row">
                <!-- 프로필 정보 -->
                <div class="col-md-4">
                    <div class="mypage-card">
                        <div class="profile-section">
                            <div class="profile-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <h4 id="userName">사용자명</h4>
                            <p class="text-muted" id="userId">사용자 ID</p>
                            <p class="text-muted" id="userPhone">전화번호</p>
                            <p class="text-muted" id="userLocation">주소</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="editProfile()">
                                <i class="fas fa-edit"></i> 정보 수정
                            </button>
                        </div>
                    </div>

                    <!-- 통계 정보 -->
                    <div class="stats-card">
                        <h5><i class="fas fa-chart-bar"></i> 예약 통계</h5>
                        <div class="row text-center">
                            <div class="col-6">
                                <h4 id="totalBookings">0</h4>
                                <small>전체 예약</small>
                            </div>
                            <div class="col-6">
                                <h4 id="activeBookings">0</h4>
                                <small>활성 예약</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 탭 콘텐츠 -->
                <div class="col-md-8">
                    <div class="mypage-card">
                        <ul class="nav nav-tabs" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="bookings-tab" data-bs-toggle="tab" 
                                        data-bs-target="#bookings" type="button" role="tab">
                                    <i class="fas fa-calendar-check"></i> 내 예약
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="favorites-tab" data-bs-toggle="tab" 
                                        data-bs-target="#favorites" type="button" role="tab">
                                    <i class="fas fa-heart"></i> 즐겨찾기
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" 
                                        data-bs-target="#reviews" type="button" role="tab">
                                    <i class="fas fa-star"></i> 내 리뷰
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="myTabContent">
                            <!-- 예약 탭 -->
                            <div class="tab-pane fade show active" id="bookings" role="tabpanel">
                                <div class="mt-3">
                                    <h5>내 예약 목록</h5>
                                    <div id="bookingsList">
                                        <div class="text-center text-muted py-4">
                                            <i class="fas fa-spinner fa-spin"></i> 로딩 중...
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 즐겨찾기 탭 -->
                            <div class="tab-pane fade" id="favorites" role="tabpanel">
                                <div class="mt-3">
                                    <h5>즐겨찾기 레스토랑</h5>
                                    <div id="favoritesList">
                                        <div class="text-center text-muted py-4">
                                            <i class="fas fa-spinner fa-spin"></i> 로딩 중...
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 리뷰 탭 -->
                            <div class="tab-pane fade" id="reviews" role="tabpanel">
                                <div class="mt-3">
                                    <h5>내 리뷰</h5>
                                    <div id="reviewsList">
                                        <div class="text-center text-muted py-4">
                                            <i class="fas fa-spinner fa-spin"></i> 로딩 중...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">&copy; 2024 레스토랑 예약 시스템. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentUser = null;

        // 페이지 로드 시 사용자 정보 로드
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadUserBookings();
            loadUserFavorites();
            loadUserReviews();
        });

        // 사용자 정보 로드
        async function loadUserInfo() {
            try {
                // 로그인된 사용자 정보 가져오기 (세션에서)
                const response = await fetch('/me');
                if (response.ok) {
                    currentUser = await response.json();
                    updateUserProfile(currentUser);
                } else {
                    // 로그인되지 않은 경우 로그인 페이지로 리다이렉트
                    window.location.href = '/login-page';
                }
            } catch (error) {
                console.error('사용자 정보 로드 실패:', error);
                window.location.href = '/login-page';
            }
        }

        // 사용자 프로필 업데이트
        function updateUserProfile(user) {
            document.getElementById('userName').textContent = user.userName;
            document.getElementById('userId').textContent = user.userId;
            document.getElementById('userPhone').textContent = user.phoneNumber;
            document.getElementById('userLocation').textContent = user.userLocation || '주소 없음';
            
            // 통계 정보 업데이트
            if (user.totalBookings !== undefined) {
                document.getElementById('totalBookings').textContent = user.totalBookings;
            }
            if (user.confirmedBookings !== undefined) {
                document.getElementById('activeBookings').textContent = user.confirmedBookings;
            }
        }

        // 사용자 예약 목록 로드
        async function loadUserBookings() {
            if (!currentUser) return;

            try {
                const response = await fetch(`/reservations?userId=${currentUser.userId}`);
                if (response.ok) {
                    const bookings = await response.json();
                    displayBookings(bookings);
                }
            } catch (error) {
                console.error('예약 목록 로드 실패:', error);
                document.getElementById('bookingsList').innerHTML = 
                    '<div class="text-center text-muted py-4">예약 목록을 불러올 수 없습니다.</div>';
            }
        }

        // 예약 목록 표시
        function displayBookings(bookings) {
            const bookingsList = document.getElementById('bookingsList');
            
            if (bookings.length === 0) {
                bookingsList.innerHTML = '<div class="text-center text-muted py-4">예약이 없습니다.</div>';
                return;
            }

            const bookingsHtml = bookings.map(booking => `
                <div class="booking-card">
                    <div class="row">
                        <div class="col-md-8">
                            <h6>${booking.storeName || '레스토랑'}</h6>
                            <p class="mb-1">
                                <i class="fas fa-calendar"></i> ${new Date(booking.bookingDate).toLocaleDateString()}
                            </p>
                            <p class="mb-1">
                                <i class="fas fa-users"></i> ${booking.count}명
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge ${getStatusBadgeClass(booking.bookingStateCode)}">
                                ${getStatusText(booking.bookingStateCode)}
                            </span>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-danger" onclick="cancelBooking(${booking.bookingNum})">
                                    취소
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            bookingsList.innerHTML = bookingsHtml;
        }

        // 상태별 배지 클래스
        function getStatusBadgeClass(status) {
            switch (status) {
                case 0: return 'bg-warning'; // PENDING
                case 1: return 'bg-success'; // CONFIRMED
                case 2: return 'bg-danger';  // CANCELLED
                default: return 'bg-secondary';
            }
        }

        // 상태별 텍스트
        function getStatusText(status) {
            switch (status) {
                case 0: return '대기중';
                case 1: return '확정';
                case 2: return '취소됨';
                default: return '알 수 없음';
            }
        }

        // 예약 취소
        async function cancelBooking(bookingNum) {
            if (!confirm('정말로 이 예약을 취소하시겠습니까?')) return;

            try {
                const response = await fetch(`/reservations/${bookingNum}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ bookingStateCode: 2 })
                });

                if (response.ok) {
                    alert('예약이 성공적으로 취소되었습니다.');
                    loadUserBookings();
                } else {
                    alert('예약 취소에 실패했습니다.');
                }
            } catch (error) {
                console.error('예약 취소 오류:', error);
                alert('예약 취소 중 오류가 발생했습니다.');
            }
        }

        // 즐겨찾기 목록 로드
        async function loadUserFavorites() {
            if (!currentUser) return;

            try {
                const response = await fetch(`/favorites?userId=${currentUser.userId}`);
                if (response.ok) {
                    const favorites = await response.json();
                    displayFavorites(favorites);
                }
            } catch (error) {
                console.error('즐겨찾기 목록 로드 실패:', error);
                document.getElementById('favoritesList').innerHTML = 
                    '<div class="text-center text-muted py-4">즐겨찾기 목록을 불러올 수 없습니다.</div>';
            }
        }

        // 즐겨찾기 목록 표시
        function displayFavorites(favorites) {
            const favoritesList = document.getElementById('favoritesList');
            
            if (favorites.length === 0) {
                favoritesList.innerHTML = '<div class="text-center text-muted py-4">즐겨찾기한 레스토랑이 없습니다.</div>';
                return;
            }

            const favoritesHtml = favorites.map(favorite => `
                <div class="booking-card">
                    <div class="row">
                        <div class="col-md-8">
                            <h6>${favorite.storeName || '레스토랑'}</h6>
                            <p class="mb-1 text-muted">${favorite.storeLocation || ''}</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-sm btn-outline-danger" onclick="removeFavorite(${favorite.favStoreId})">
                                <i class="fas fa-heart-broken"></i> 제거
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            favoritesList.innerHTML = favoritesHtml;
        }

        // 즐겨찾기 제거
        async function removeFavorite(favStoreId) {
            if (!confirm('즐겨찾기에서 제거하시겠습니까?')) return;

            try {
                const response = await fetch(`/favorites/${favStoreId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('즐겨찾기에서 제거되었습니다.');
                    loadUserFavorites();
                } else {
                    alert('즐겨찾기 제거에 실패했습니다.');
                }
            } catch (error) {
                console.error('즐겨찾기 제거 오류:', error);
                alert('즐겨찾기 제거 중 오류가 발생했습니다.');
            }
        }

        // 리뷰 목록 로드
        async function loadUserReviews() {
            if (!currentUser) return;

            try {
                const response = await fetch(`/reviews?userId=${currentUser.userId}`);
                if (response.ok) {
                    const reviews = await response.json();
                    displayReviews(reviews);
                }
            } catch (error) {
                console.error('리뷰 목록 로드 실패:', error);
                document.getElementById('reviewsList').innerHTML = 
                    '<div class="text-center text-muted py-4">리뷰 목록을 불러올 수 없습니다.</div>';
            }
        }

        // 리뷰 목록 표시
        function displayReviews(reviews) {
            const reviewsList = document.getElementById('reviewsList');
            
            if (reviews.length === 0) {
                reviewsList.innerHTML = '<div class="text-center text-muted py-4">작성한 리뷰가 없습니다.</div>';
                return;
            }

            const reviewsHtml = reviews.map(review => `
                <div class="booking-card">
                    <div class="row">
                        <div class="col-md-8">
                            <h6>${review.storeName || '레스토랑'}</h6>
                            <p class="mb-1">${review.comment || ''}</p>
                            <div class="mb-1">
                                ${'★'.repeat(review.ratio)}${'☆'.repeat(10-review.ratio)}
                                <span class="text-muted">(${review.ratio}/10)</span>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-sm btn-outline-primary" onclick="editReview(${review.reviewId})">
                                수정
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteReview(${review.reviewId})">
                                삭제
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            reviewsList.innerHTML = reviewsHtml;
        }

        // 리뷰 수정
        function editReview(reviewId) {
            // 리뷰 수정 모달 또는 페이지로 이동
            alert('리뷰 수정 기능은 준비 중입니다.');
        }

        // 리뷰 삭제
        async function deleteReview(reviewId) {
            if (!confirm('정말로 이 리뷰를 삭제하시겠습니까?')) return;

            try {
                const response = await fetch(`/reviews/${reviewId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('리뷰가 성공적으로 삭제되었습니다.');
                    loadUserReviews();
                } else {
                    alert('리뷰 삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('리뷰 삭제 오류:', error);
                alert('리뷰 삭제 중 오류가 발생했습니다.');
            }
        }

        // 프로필 수정
        function editProfile() {
            alert('프로필 수정 기능은 준비 중입니다.');
        }
    </script>
</body>
</html> 